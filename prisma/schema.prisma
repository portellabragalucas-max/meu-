// Prisma Schema for Nexora - AI Study Optimization Platform
// Uses SQLite for local development, easily switchable to PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StudyBlockType {
  AULA
  EXERCICIOS
  REVISAO
  SIMULADO_AREA
  SIMULADO_COMPLETO
  ANALISE
}

enum StudySessionType {
  AULA
  EXERCICIOS
  REVISAO
  SIMULADO
  ANALISE
  LIVRE
}

enum DifficultyScore {
  MUITO_BAIXA
  BAIXA
  MEDIA
  ALTA
  MUITO_ALTA
}

// User profile with gamification stats
model User {
  id     String  @id @default(cuid())
  email  String  @unique
  name   String
  passwordHash String?
  avatar String?
  image  String?
  emailVerified DateTime?

  // Gamification
  xp            Int       @default(0)
  level         Int       @default(1)
  streak        Int       @default(0)
  longestStreak Int       @default(0)
  lastStudyDate DateTime?

  // Preferences
  dailyGoalHours  Float  @default(4.0)
  preferredStart  String @default("09:00")
  preferredEnd    String @default("21:00")
  maxBlockMinutes Int    @default(120)
  breakMinutes    Int    @default(15)

  // AI Settings
  aiDifficulty String  @default("adaptive") // easy, medium, hard, adaptive
  focusMode    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subjects      Subject[]
  studyBlocks   StudyBlock[]
  studySessions StudySession[]
  achievements  UserAchievement[]
  preferences  UserPreferences?
  accounts     Account[]
  sessions     Session[]
  pushSubscriptions PushSubscription[]
  notifications UserNotification[]
  performanceMetrics PerformanceMetrics[]
  topicProgress TopicProgress[]
}

model UserPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique
  dailyGoalHours  Float    @default(4.0)
  dailyHoursByWeekday Json?
  preferredStart  String   @default("09:00")
  preferredEnd    String   @default("21:00")
  maxBlockMinutes Int      @default(120)
  breakMinutes    Int      @default(15)
  alarmSound      String?  @default("pulse")
  dailyReminder   Boolean  @default(true)
  streakReminder  Boolean  @default(true)
  achievementAlerts Boolean @default(true)
  weeklyReport    Boolean  @default(true)
  restDays        String   @default("[]")
  examDate        String?
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Study subjects with priority and difficulty settings
model Subject {
  id     String @id @default(cuid())
  userId String
  name   String
  color  String @default("#00B4FF")
  icon   String @default("book")

  // Study parameters
  priority       Int   @default(5) // 1-10 scale
  difficulty     Int   @default(5) // 1-10 scale
  targetHours    Float @default(10.0) // Weekly target
  completedHours Float @default(0.0) // This week

  // Progress tracking
  totalHours    Float @default(0.0)
  sessionsCount Int   @default(0)
  averageScore  Float @default(0.0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  studyBlocks   StudyBlock[]
  studySessions StudySession[]
  performanceMetrics PerformanceMetrics[]
  topicProgress TopicProgress[]

  @@index([userId])
}

// Planned study blocks (the schedule)
model StudyBlock {
  id        String @id @default(cuid())
  userId    String
  subjectId String

  // Timing
  date            DateTime
  startTime       String // "09:00" format
  endTime         String // "11:00" format
  durationMinutes Int

  type           StudyBlockType? @default(AULA)
  description    String?
  sequenceIndex  Int?
  relatedSubjectId String?

  // Status
  status  String  @default("scheduled") // scheduled, in-progress, completed, skipped
  isBreak Boolean @default(false)

  // AI generated vs manual
  isAutoGenerated Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  session StudySession?

  @@index([userId, date])
  @@index([subjectId])
}

// Actual study sessions (completed work)
model StudySession {
  id        String  @id @default(cuid())
  userId    String
  subjectId String
  blockId   String? @unique

  // Timing
  startedAt      DateTime
  endedAt        DateTime?
  plannedMinutes Int
  actualMinutes  Int       @default(0)

  // Performance metrics
  focusScore        Int     @default(0) // 0-100
  productivityScore Int     @default(0) // 0-100
  accuracyRate      Float?
  errorRate         Float?
  sessionType       StudySessionType?
  difficultyLabel   DifficultyScore?
  difficultyScore   Int?
  correctAnswers    Int?
  totalQuestions    Int?
  topicName         String?
  notes             String?

  // XP earned for this session
  xpEarned Int @default(0)

  createdAt DateTime @default(now())

  // Relations
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  block   StudyBlock? @relation(fields: [blockId], references: [id])

  @@index([userId, startedAt])
  @@index([subjectId])
}

model PerformanceMetrics {
  id        String   @id @default(cuid())
  userId    String
  subjectId String
  blockId   String?
  date      DateTime @default(now())
  sessionType StudySessionType @default(LIVRE)
  accuracyRate Float @default(0.0)
  errorRate    Float @default(0.0)
  focusScore   Int   @default(0)
  productivityScore Int @default(0)
  difficultyScore   Int?
  correctAnswers    Int?
  totalQuestions    Int?
  minutesStudied    Int @default(0)
  topicName         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([subjectId, date])
  @@index([userId, subjectId])
}

model TopicProgress {
  id        String   @id @default(cuid())
  userId    String
  subjectId String
  topicName String
  mastery   Float    @default(0.0)
  accuracyRate Float @default(0.0)
  sessionsCount Int  @default(0)
  lastStudiedAt DateTime?
  nextReviewDate DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([userId, subjectId, topicName])
  @@index([userId, nextReviewDate])
  @@index([subjectId])
}

// Achievement definitions
model Achievement {
  id          String @id @default(cuid())
  name        String @unique
  description String
  icon        String
  xpReward    Int    @default(100)

  // Unlock conditions (JSON stored as string)
  condition String // e.g., {"type": "streak", "value": 7}

  // Rarity for display
  rarity String @default("common") // common, rare, epic, legendary

  // Relations
  userAchievements UserAchievement[]
}

// User unlocked achievements
model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

// Weekly analytics snapshots
model WeeklyStats {
  id        String   @id @default(cuid())
  userId    String
  weekStart DateTime

  // Aggregated stats
  totalHours      Float @default(0.0)
  sessionsCount   Int   @default(0)
  avgFocusScore   Float @default(0.0)
  avgProductivity Float @default(0.0)
  goalsCompleted  Int   @default(0)
  xpEarned        Int   @default(0)

  // Daily breakdown (JSON as string)
  dailyBreakdown String @default("[]")

  createdAt DateTime @default(now())

  @@unique([userId, weekStart])
  @@index([userId])
}

// Study presets - Predefined study configurations based on objectives
model StudyPreset {
  id          String @id @default(cuid())
  name        String @unique // e.g., "ENEM", "Medicina", "Direito", "Concursos"
  description String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subjects PresetSubject[]

  @@index([name])
}

// Subjects within a preset
model PresetSubject {
  id                     String @id @default(cuid())
  presetId               String
  name                   String
  priority               Int    @default(3) // 1-5 scale (mapped to 1-10 in Subject)
  difficulty             Int    @default(3) // 1-5 scale (mapped to 1-10 in Subject)
  recommendedWeeklyHours Float  @default(10.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  preset StudyPreset @relation(fields: [presetId], references: [id], onDelete: Cascade)

  @@index([presetId])
}

// Onboarding profile generated from wizard
model UserProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  study_goal         String
  routine_type       String
  best_time          String
  daily_hours        String
  learning_style     String
  study_days         Int
  fatigue_profile    String
  default_start_time String
  block_duration     Int
  intensity_level    String
  active_days        String // JSON array
  practice_weight    Float
  focus_subjects     String // JSON array
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserNotification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String?
  url       String?
  dedupeKey String?
  readAt    DateTime?
  pushedAt  DateTime?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@unique([userId, dedupeKey])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
