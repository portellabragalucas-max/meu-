// Prisma Schema for Nexora - AI Study Optimization Platform
// Uses SQLite for local development, easily switchable to PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User profile with gamification stats
model User {
  id     String  @id @default(cuid())
  email  String  @unique
  name   String
  avatar String?

  // Gamification
  xp            Int       @default(0)
  level         Int       @default(1)
  streak        Int       @default(0)
  longestStreak Int       @default(0)
  lastStudyDate DateTime?

  // Preferences
  dailyGoalHours  Float  @default(4.0)
  preferredStart  String @default("09:00")
  preferredEnd    String @default("21:00")
  maxBlockMinutes Int    @default(120)
  breakMinutes    Int    @default(15)

  // AI Settings
  aiDifficulty String  @default("adaptive") // easy, medium, hard, adaptive
  focusMode    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subjects      Subject[]
  studyBlocks   StudyBlock[]
  studySessions StudySession[]
  achievements  UserAchievement[]
}

// Study subjects with priority and difficulty settings
model Subject {
  id     String @id @default(cuid())
  userId String
  name   String
  color  String @default("#00B4FF")
  icon   String @default("book")

  // Study parameters
  priority       Int   @default(5) // 1-10 scale
  difficulty     Int   @default(5) // 1-10 scale
  targetHours    Float @default(10.0) // Weekly target
  completedHours Float @default(0.0) // This week

  // Progress tracking
  totalHours    Float @default(0.0)
  sessionsCount Int   @default(0)
  averageScore  Float @default(0.0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  studyBlocks   StudyBlock[]
  studySessions StudySession[]

  @@index([userId])
}

// Planned study blocks (the schedule)
model StudyBlock {
  id        String @id @default(cuid())
  userId    String
  subjectId String

  // Timing
  date            DateTime
  startTime       String // "09:00" format
  endTime         String // "11:00" format
  durationMinutes Int

  // Status
  status  String  @default("scheduled") // scheduled, in-progress, completed, skipped
  isBreak Boolean @default(false)

  // AI generated vs manual
  isAutoGenerated Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  session StudySession?

  @@index([userId, date])
  @@index([subjectId])
}

// Actual study sessions (completed work)
model StudySession {
  id        String  @id @default(cuid())
  userId    String
  subjectId String
  blockId   String? @unique

  // Timing
  startedAt      DateTime
  endedAt        DateTime?
  plannedMinutes Int
  actualMinutes  Int       @default(0)

  // Performance metrics
  focusScore        Int     @default(0) // 0-100
  productivityScore Int     @default(0) // 0-100
  notes             String?

  // XP earned for this session
  xpEarned Int @default(0)

  createdAt DateTime @default(now())

  // Relations
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  block   StudyBlock? @relation(fields: [blockId], references: [id])

  @@index([userId, startedAt])
  @@index([subjectId])
}

// Achievement definitions
model Achievement {
  id          String @id @default(cuid())
  name        String @unique
  description String
  icon        String
  xpReward    Int    @default(100)

  // Unlock conditions (JSON stored as string)
  condition String // e.g., {"type": "streak", "value": 7}

  // Rarity for display
  rarity String @default("common") // common, rare, epic, legendary

  // Relations
  userAchievements UserAchievement[]
}

// User unlocked achievements
model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

// Weekly analytics snapshots
model WeeklyStats {
  id        String   @id @default(cuid())
  userId    String
  weekStart DateTime

  // Aggregated stats
  totalHours      Float @default(0.0)
  sessionsCount   Int   @default(0)
  avgFocusScore   Float @default(0.0)
  avgProductivity Float @default(0.0)
  goalsCompleted  Int   @default(0)
  xpEarned        Int   @default(0)

  // Daily breakdown (JSON as string)
  dailyBreakdown String @default("[]")

  createdAt DateTime @default(now())

  @@unique([userId, weekStart])
  @@index([userId])
}

// Study presets - Predefined study configurations based on objectives
model StudyPreset {
  id          String @id @default(cuid())
  name        String @unique // e.g., "ENEM", "Medicina", "Direito", "Concursos"
  description String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subjects PresetSubject[]

  @@index([name])
}

// Subjects within a preset
model PresetSubject {
  id                     String @id @default(cuid())
  presetId               String
  name                   String
  priority               Int    @default(3) // 1-5 scale (mapped to 1-10 in Subject)
  difficulty             Int    @default(3) // 1-5 scale (mapped to 1-10 in Subject)
  recommendedWeeklyHours Float  @default(10.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  preset StudyPreset @relation(fields: [presetId], references: [id], onDelete: Cascade)

  @@index([presetId])
}

// Onboarding profile generated from wizard
model UserProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  study_goal         String
  routine_type       String
  best_time          String
  daily_hours        String
  learning_style     String
  study_days         Int
  fatigue_profile    String
  default_start_time String
  block_duration     Int
  intensity_level    String
  active_days        String // JSON array
  practice_weight    Float
  focus_subjects     String // JSON array
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}
